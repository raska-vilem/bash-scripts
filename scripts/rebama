#!/bin/bash

# Function to display messages with color
function echo_info() {
  echo "\033[0;34m[INFO] $1\033[0m"
}

function echo_success() {
  echo "\033[0;32m[SUCCESS] $1\033[0m"
}

function echo_error() {
  echo "\033[0;31m[ERROR] $1\033[0m"
}

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo_info "Current branch: $current_branch"

# Determine main branch (master or main)
if git show-ref --verify --quiet refs/heads/main; then
  main_branch="main"
elif git show-ref --verify --quiet refs/heads/master; then
  main_branch="master"
else
  echo_error "Neither 'main' nor 'master' branch found"
  exit 1
fi

echo_info "Main branch detected as: $main_branch"

# Check if we're already on the main branch
if [[ "$current_branch" == "$main_branch" ]]; then
  echo_error "Already on $main_branch branch. No need to rebase."
  exit 0
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  # Stash changes
  echo_info "Stashing changes..."
  stash_result=$(git stash push -m "Auto-stashed for rebase workflow")
  
  if [[ "$stash_result" == "No local changes to save" ]]; then
    has_stashed=false
    echo_info "No changes to stash"
  else
    has_stashed=true
    echo_info "Changes stashed successfully"
  fi
else
  has_stashed=false
  echo_info "No local changes detected"
fi

# Checkout main branch
echo_info "Checking out $main_branch branch..."
if ! git checkout "$main_branch"; then
  echo_error "Failed to checkout $main_branch"
  exit 1
fi

# Pull latest changes
echo_info "Pulling latest changes from $main_branch..."
if ! git pull origin "$main_branch"; then
  echo_error "Failed to pull from $main_branch"
  # Return to original branch
  git checkout "$current_branch"
  # Apply stash if we stashed changes
  if [[ "$has_stashed" == true ]]; then
    echo_info "Applying stashed changes..."
    git stash pop
  fi
  exit 1
fi

# Return to the original branch
echo_info "Checking out original branch: $current_branch..."
if ! git checkout "$current_branch"; then
  echo_error "Failed to checkout $current_branch"
  exit 1
fi

# Rebase onto main branch
echo_info "Rebasing $current_branch onto $main_branch..."
if ! git rebase "$main_branch"; then
  echo_error "Rebase conflict detected. Resolve conflicts and continue the rebase manually."
  echo_info "After resolving conflicts, run: git rebase --continue"
  echo_info "Then run: git push --force-with-lease origin $current_branch"
  
  # Apply stash if we stashed changes (after resolving rebase)
  if [[ "$has_stashed" == true ]]; then
    echo_info "Don't forget to apply your stashed changes after completing the rebase:"
    echo_info "git stash pop"
  fi
  exit 1
fi

# Force push if rebase successful
echo_info "Force pushing changes to remote..."
if ! git push --force-with-lease origin "$current_branch"; then
  echo_error "Failed to push changes to remote"
  # Apply stash if we stashed changes
  if [[ "$has_stashed" == true ]]; then
    echo_info "Applying stashed changes..."
    git stash pop
  fi
  exit 1
fi

# Apply stashed changes if any
if [[ "$has_stashed" == true ]]; then
  echo_info "Applying stashed changes..."
  if ! git stash pop; then
    echo_error "Failed to apply stashed changes due to conflicts."
    echo_info "Resolve conflicts manually and run: git stash drop when finished"
    exit 1
  fi
fi

echo_success "Complete! Your branch $current_branch is now rebased on $main_branch and pushed to remote."

